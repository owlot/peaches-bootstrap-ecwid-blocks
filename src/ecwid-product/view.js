import { store, getContext } from '@wordpress/interactivity';

const { state } = store( 'peaches-ecwid-product', {
	state: {
		get productData() {
			const context = getContext();
			return context.product;
		},

		get productId() {
			const context = getContext();
			return context.productId;
		},

		get productName() {
			const product = state.productData;
			return product ? product.name : '';
		},

		get productImage() {
			const product = state.productData;
			return product && product.thumbnailUrl ? product.thumbnailUrl : '';
		},

		get productSubtitle() {
			const product = state.productData;
			if ( ! product || ! product.attributes ) {
				return '';
			}

			const subtitleAttribute = product.attributes.find(
				( attr ) =>
					attr.name.toLowerCase().includes( 'ondertitel' ) ||
					attr.name.toLowerCase().includes( 'subtitle' ) ||
					attr.name.toLowerCase().includes( 'sub-title' ) ||
					attr.name.toLowerCase().includes( 'tagline' )
			);

			return (
				subtitleAttribute?.valueTranslated?.nl ||
				subtitleAttribute?.value ||
				''
			);
		},

		get productPrice() {
			const product = state.productData;
			return product && product.price ? `â‚¬ ${ product.price }` : '';
		},

		get productUrl() {
			const product = state.productData;
			if ( ! product ) {
				return '';
			}

			// If the server provided a complete URL, use it
			if ( product.url ) {
				return product.url;
			}

			// Fallback URL generation
			const currentPath = window.location.pathname;
			let langPrefix = '';

			// Detect language from URL path
			const langMatch = currentPath.match( /^\/([a-z]{2})\// );
			if ( langMatch && langMatch[ 1 ] ) {
				langPrefix = `/${ langMatch[ 1 ] }`;
			}

			// Get shop path
			let shopPath = 'shop'; // Default fallback

			// Adjust shop path based on detected language
			if ( langMatch && langMatch[ 1 ] ) {
				const lang = langMatch[ 1 ];
				if ( lang === 'nl' ) {
					shopPath = 'winkel';
				} else if ( lang === 'fr' ) {
					shopPath = 'boutique';
				} else if ( lang === 'de' ) {
					shopPath = 'geschaeft';
				}
			}

			return `${ window.location.origin }${ langPrefix }/${ shopPath }/${ product.autogeneratedSlug }/`;
		},

		get hasHoverImage() {
			const context = getContext();
			return !! context.hoverImageUrl;
		},
	},

	actions: {
		navigateToProduct() {
			const url = state.productUrl;
			if ( url ) {
				window.location.href = url;
			}
		},
		addToCart( e ) {
			const context = getContext();
			const productId = state.productId;

			if ( productId ) {
				// Check if Ecwid cart API is available
				if ( typeof Ecwid !== 'undefined' && Ecwid.Cart ) {
					try {
						Ecwid.Cart.addProduct( {
							id: productId,
							quantity: 1,
						} );
					} catch ( error ) {
						console.error( 'Error adding product to cart:', error );
					}
				} else {
					console.error( 'Ecwid Cart API not available' );
				}
			} else {
				console.error( 'Product ID not found' );
			}
		},
		handleMouseEnter() {
			const context = getContext();
			if ( context.hoverImageUrl ) {
				context.isHovering = true;
			}
		},

		handleMouseLeave() {
			const context = getContext();
			context.isHovering = false;
		},
	},

	callbacks: {
		*initProduct() {
			const context = getContext();
			context.isLoading = false;
		},
	},
} );
